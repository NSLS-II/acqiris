## configure the board for all channels: start/stop DAQ, converters per channel
## Sample interval, sample length, trigger source, diagnostics info, etc.
##DIG NSLS2 naming:[PSy[:PI]][-SSy[:SI]][-TSy[:TI]]{Dev[:DI]}[SgN[:SgI][-SgD]] 
#### Psy	-	Primary system
#### Ssy	-	Secondary system
#### Dev	-	Device name
## MODULE   -	"0" is the first digitizer found during initialization.
##       For Acqiris crate and CPU, it's the top slot if there's one digitizer 
## NELM     -	max. number of samples to be acquired 

record(mbbo,"${DIG}DAQStatus-Sel")
{
   field(DESC,"DAQStatus")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} MDQST")
   field(PINI,"YES")
   field(SCAN,"Passive")
   field(ZRVL,"0")
   field(ZRST,"Stopped")
   field(ONVL,"1")
   field(ONST,"Running")
   info(autosaveFields_pass0, "RVAL")
}

record(longout,"${DIG}NbrConvertersPerChannel-SP")
{
   field(DESC,"nbrConvertersPerChannel")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} MNCPC")
   field(PINI,"YES")
   field(SCAN,"Passive")
#DOL and VAL works: must use one of them to avoid 'Floating point exception'
   field(DOL, "1")
   #field(VAL,"1")
   #info(autosaveFields_pass0, "VAL")
    info(autosaveFields_pass1, "VAL")
}

record(ao,"${DIG}SampFreq-SP")
{
   field(SCAN,"Passive")
   field(DESC,"sampFreq")
   field(PINI,"YES")
   field(DRVH,"8000000000")
   field(DRVL,"100")
   field(HOPR,"8000000000")
   field(LOPR,"100") 
#initial sampleRate: 100MHz
   field(VAL,"100000000")
   field(EGU,"Hz")
   field(FLNK,"${DIG}SampFreq-Calc_")
   #use 'VAL' instead of 'RVAL'
   info(autosaveFields_pass0, "VAL")
}

record(calc,"${DIG}SampFreq-Calc_")
{
   field(SCAN,"Passive")
   field(DESC,"calc sampInterval")
   #field(PINI,"YES")
   field(INPA,"${DIG}SampFreq-SP")
   field(CALC, "(A < 100)?100:(1.0/A)")
   #the expression below seems OK
   #field(CALC, "1.0/A")
   #field(OUT, "${DIG}SampInterval-SP PP")
   field(FLNK,"${DIG}SampInterval-SP")
}

record(ao,"${DIG}SampInterval-SP")
{
   field(DESC,"sampInterval")
   field(DTYP,"acqiris")
   field(DOL,"${DIG}SampFreq-Calc_")
   field(OMSL,"closed_loop")
   field(OUT,"@M${MODULE} MSMIN")
   #field(PINI,"YES")
   field(SCAN,"Passive")
   field(EGU,"Sec")
   field(PREC,"4")
   #use 'VAL' instead of 'RVAL'
   #info(autosaveFields_pass0, "VAL")
}

record(longout,"${DIG}NbrSamples-SP")
{
   field(DESC,"Number of Samples")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} MNSMP")
   field(PINI,"YES")
   field(SCAN,"Passive")
   #Max. number of samples <= NELM of waveform in acqiris_channel.db
   field(DRVH,"${NELM}")
   field(DRVL,"1")
   field(HOPR,"${NELM}")
   field(LOPR,"1")
#initial NbrSamples: 1000
   field(VAL,"1000")
   field(EGU,"Samples")
   info(autosaveFields_pass0, "VAL")
   field(FLNK,"${DIG}TimeAxis-ASub_")
 }

record(calc,"${DIG}SampLength-I")
{
   field(DESC,"Sample length:ns")
   field(SCAN,"Passive")
   field(INPA,"${DIG}SampInterval-SP CP")
   field(INPB,"${DIG}NbrSamples-SP CP")
   field(CALC, "A*B*(1e+09)")  
   field(EGU,"ns")
   field(FLNK,"${DIG}TimeAxis-ASub_")
}

record(aSub,"${DIG}TimeAxis-ASub_")
{
    field(DESC,"construct time axis")
    field(INAM,"timeAxisAsubInit")
    field(SNAM,"timeAxisAsubProcess")
    #get samples/data points
    field (INPA, "${DIG}NbrSamples-SP")
    field (FTA, "ULONG")
    field (NOA, "1")
    #get sample length (ns) 
    #no error message even when typing wrong PV '${DIG}SampLength-SP'
    field (INPB, "${DIG}SampLength-I")
    field (FTB, "DOUBLE")
    field (NOB, "1")
    #waveform data for time axis             
    field (OUTA, "${DIG}TimeAxis-Wf PP")
    field (FTVA, "DOUBLE")
    field (NOVA, "${NELM}")
}

record(waveform,"${DIG}TimeAxis-Wf")
{
   field(SCAN,"Passive")
   field(DESC,"Time axis: ns unit")
   field(PINI,"YES")
   field(NELM,"${NELM}")
   field(FTVL,"DOUBLE")
   field(INP,"${DIG}TimeAxis-ASub_.VALA")
   field(PREC,"3")
   field(EGU,"ns")
}

record(longin,"${DIG}EventCount-RB")
{
   field(DESC,"EventCount")
   field(DTYP,"acqiris")
   field(INP,"@M${MODULE} MEVCN")
   field(PINI,"YES")
   field(SCAN,"1 second")
   field(FLNK,"${DIG}TrigRate-I_")
}

record(calc,"${DIG}TrigRate-I_")
{
   field(DESC,"calc trigger rate from EventCount")
   #field(INPA,"${DIG}EventCount-RB")
   #field(INPB,"${DIG}PreEventCount-I_")
   field(INPA,"${DIG}TrigRate-I_.B")
   field(INPB,"${DIG}EventCount-RB")
   field(CALC, "B-A")
   field(EGU,"Hz")
   #field(FLNK,"${DIG}PreEventCount-I_")
}

record(ai,"${DIG}PreEventCount-I_")
{
   field(SCAN,"Passive")
   field(DESC,"old/previous count")
   field(INP,"${DIG}TrigRate-I_")
}

record(longin,"${DIG}TriggerTimeouts-RB")
{
   field(DESC,"TriggerTimeouts")
   field(DTYP,"acqiris")
   field(INP,"@M${MODULE} MTRTM")
   field(PINI,"YES")
   field(SCAN,"1 second")
}

record(longin,"${DIG}CrateNb-RB")
{
   field(DESC,"CrateNb")
   field(DTYP,"acqiris")
   field(INP,"@M${MODULE} MCRTN")
   field(PINI,"YES")
   field(SCAN,"Passive")
}

record(ai,"${DIG}DelayOffset-RB")
{
   field(DESC,"DelayOffset")
   field(DTYP,"acqiris")
   field(INP,"@M${MODULE} MDLOF")
   field(PINI,"YES")
   field(SCAN,"2 second")
}

record(ai,"${DIG}DelayScale-RB")
{
   field(DESC,"DelayScale")
   field(DTYP,"acqiris")
   field(INP,"@M${MODULE} MDLSC")
   field(PINI,"YES")
   field(SCAN,"2 second")
}

record(longin,"${DIG}IsPreTriggerRunning-RB")
{
   field(DESC,"IsPreTriggerRunning")
   field(DTYP,"acqiris")
   field(INP,"@M${MODULE} MIPTR")
   field(PINI,"YES")
   field(SCAN,"2 second")
}

record(longin,"${DIG}MaxSamplesPerChannel-RB")
{
   field(DESC,"MaxSamplesPerChannel")
   field(DTYP,"acqiris")
   field(INP,"@M${MODULE} MMSPC")
   field(PINI,"YES")
   field(SCAN,"Passive")
}

record(longin,"${DIG}NbrADCBits-RB")
{
   field(DESC,"NbrADCBits")
   field(DTYP,"acqiris")
   field(INP,"@M${MODULE} MNADB")
   field(PINI,"YES")
   field(SCAN,"Passive")
   field(EGU, "bit")
}

record(longin,"${DIG}NbrModulesInInstrument-RB")
{
   field(DESC,"NbrModulesInInstrument")
   field(DTYP,"acqiris")
   field(INP,"@M${MODULE} MNMII")
   field(PINI,"YES")
   field(SCAN,"Passive")
}

record(longin,"${DIG}PosInCrate-RB")
{
   field(DESC,"PosInCrate")
   field(DTYP,"acqiris")
   field(INP,"@M${MODULE} MPICR")
   field(PINI,"YES")
   field(SCAN,"Passive")
}

record(longin,"${DIG}Temperature_m-RB")
{
   field(DESC,"Temperature_m")
   field(DTYP,"acqiris")
   field(INP,"@M${MODULE} MTMPM")
   field(PINI,"YES")
   field(SCAN,"2 second")
   field(EGU,"degC")
}

record(longout,"${DIG}UsedChannels-SP")
{
   field(DESC,"usedChannels")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} MUSCH")
   field(PINI,"YES")
   field(SCAN,"Passive")
   info(autosaveFields_pass0, "VAL")
}

record(longout,"${DIG}DelayNbrSamples-SP")
{
   field(DESC,"delayNbrSamples")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} MDLNS")
   field(PINI,"YES")
   field(SCAN,"Passive")
   info(autosaveFields_pass0, "VAL")
}

record(ao,"${DIG}DelayTime-SP")
{
   field(DESC,"delayTime")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} MDLTM")
   field(PINI,"YES")
   field(SCAN,"Passive")
   field(EGU,"sec")
   info(autosaveFields_pass0, "RVAL")
}

record(mbbo,"${DIG}TrigClass-Sel")
{
   field(DESC,"trigClass")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} MTRCL")
   field(PINI,"YES")
   field(SCAN,"Passive")
   field(ZRVL,"0")
   field(ZRST,"Edge")
   field(ONVL,"1")
   field(ONST,"TV_Trigger")
   info(autosaveFields_pass0, "RVAL")
}

record(mbbo,"${DIG}TrigSource-Sel")
{
   field(DESC,"TriggerSource")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} MTRSR")
   field(PINI,"YES")
   field(SCAN,"Passive")
   field(ZRVL,"0")
   field(ZRST,"Channel1")
   field(ONVL,"1")
   field(ONST,"Channel2")
   field(TWVL,"2")
   field(TWST,"Channel3")
   field(THVL,"3")
   field(THST,"Channel4")
   field(FRVL,"4")
   field(FRST,"External")
   field(RVAL, "4")
   info(autosaveFields_pass0, "RVAL")
}

record(longin,"${DIG}ReadErrors-RB")
{
   field(DESC,"ReadErrors")
   field(DTYP,"acqiris")
   field(INP,"@M${MODULE} MRDER")
   field(PINI,"YES")
   field(SCAN,"1 second")
}

record(longin,"${DIG}Truncated-RB")
{
   field(DESC,"TruncatedEvents")
   field(DTYP,"acqiris")
   field(INP,"@M${MODULE} MTREV")
   field(PINI,"YES")
   field(SCAN,"1 second")
}

record(longin,"${DIG}ASBusBusNb")
{
   field(DESC,"ASBusBusNb")
   field(DTYP,"acqiris")
   field(INP,"@M${MODULE} MABBN")
   field(PINI,"YES")
   field(SCAN,"Passive")
}

record(longin,"${DIG}ASBusIsMaster")
{
   field(DESC,"ASBusIsMaster")
   field(DTYP,"acqiris")
   field(INP,"@M${MODULE} MABIM")
   field(PINI,"YES")
   field(SCAN,"Passive")
}

record(longin,"${DIG}ASBusPosInCrate")
{
   field(DESC,"ASBusPosInCrate")
   field(DTYP,"acqiris")
   field(INP,"@M${MODULE} MABPI")
   field(PINI,"YES")
   field(SCAN,"Passive")
}

record(longin,"${DIG}ASBusSerialNb")
{
   field(DESC,"ASBusSerialNb")
   field(DTYP,"acqiris")
   field(INP,"@M${MODULE} MABSR")
   field(PINI,"YES")
   field(SCAN,"Passive")
}

record(longin,"${DIG}ASBusSlotNb")
{
   field(DESC,"ASBusSlotNb")
   field(DTYP,"acqiris")
   field(INP,"@M${MODULE} MABSN")
   field(PINI,"YES")
   field(SCAN,"Passive")
}

record(ai,"${DIG}ExtCkRatio")
{
   field(DESC,"ExtCkRatio")
   field(DTYP,"acqiris")
   field(INP,"@M${MODULE} MEXCR")
   field(PINI,"YES")
   field(SCAN,"2 second")
}

record(longin,"${DIG}HasTrigVeto")
{
   field(DESC,"HasTrigVeto")
   field(DTYP,"acqiris")
   field(INP,"@M${MODULE} MHHTV")
   field(PINI,"YES")
   field(SCAN,"2 second")
}

record(longin,"${DIG}LogDevDataLinks")
{
   field(DESC,"LogDevDataLinks")
   field(DTYP,"acqiris")
   field(INP,"@M${MODULE} MLDDL")
   field(PINI,"YES")
   field(SCAN,"2 second")
}

record(longin,"${DIG}NbrExternalTriggers")
{
   field(DESC,"NbrExternalTriggers")
   field(DTYP,"acqiris")
   field(INP,"@M${MODULE} MNEXT")
   field(PINI,"YES")
   field(SCAN,"Passive")
}

record(longin,"${DIG}NbrInternalTriggers")
{
   field(DESC,"NbrInternalTriggers")
   field(DTYP,"acqiris")
   field(INP,"@M${MODULE} MNINT")
   field(PINI,"YES")
   field(SCAN,"Passive")
}

record(ai,"${DIG}SSRTimeStamp")
{
   field(DESC,"SSRTimeStamp")
   field(DTYP,"acqiris")
   field(INP,"@M${MODULE} MSSTS")
   field(PINI,"YES")
   field(SCAN,"2 second")
}

record(longin,"${DIG}TbSegmentPad")
{
   field(DESC,"TbSegmentPad")
   field(DTYP,"acqiris")
   field(INP,"@M${MODULE} MTBSP")
   field(PINI,"YES")
   field(SCAN,"Passive")
}

record(longout,"${DIG}Signal")
{
   field(DESC,"signal")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} MSIGN")
   field(PINI,"YES")
   field(SCAN,"Passive")
}

record(mbbo,"${DIG}ClockType")
{
   field(DESC,"clockType")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} MCLTP")
   field(PINI,"YES")
   field(SCAN,"Passive")
   field(ZRVL,"0")
   field(ZRST,"Internal")
   field(ONVL,"1")
   field(ONST,"ExtCont")
   field(TWVL,"2")
   field(TWST,"Ext10Mhz")
   field(THVL,"3")
   field(THST,"ExtStartStop ")
}

record(ao,"${DIG}InputThreshold")
{
   field(DESC,"inputThreshold")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} MINTH")
   field(PINI,"YES")
   field(SCAN,"Passive")
}

record(ao,"${DIG}InputFrequency")
{
   field(DESC,"inputFrequency")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} MINFR")
   field(PINI,"YES")
   field(SCAN,"Passive")
   field(EGU,"Hz")
}

record(ao,"${DIG}SampFrequency")
{
   field(DESC,"sampFrequency")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} MSMFR")
   field(PINI,"YES")
   field(SCAN,"Passive")
   field(EGU,"Hz")
}

record(longout,"${DIG}FcntChannel")
{
   field(DESC,"fcntChannel")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} MFCCH")
   field(PINI,"YES")
   field(SCAN,"Passive")
}

record(mbbo,"${DIG}Type")
{
   field(DESC,"type")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} MTYPE")
   field(PINI,"YES")
   field(SCAN,"Passive")
   field(ZRVL,"0")
   field(ZRST,"Frequency")
   field(ONVL,"1")
   field(ONST,"Period")
   field(TWVL,"2")
   field(TWST,"TotByTime")
   field(THVL,"3")
   field(THST,"TotByGate")
}

record(ao,"${DIG}TargetValue")
{
   field(DESC,"targetValue")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} MTRVL")
   field(PINI,"YES")
   field(SCAN,"Passive")
}

record(ao,"${DIG}ApertureTime")
{
   field(DESC,"apertureTime")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} MAPTM")
   field(PINI,"YES")
   field(SCAN,"Passive")
}

record(longout,"${DIG}FcntFlags")
{
   field(DESC,"fcntFlags")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} MFCFL")
   field(PINI,"YES")
   field(SCAN,"Passive")
}

record(longout,"${DIG}NbrMemSegments")
{
   field(DESC,"nbrMemSegments")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} MNMMS")
   field(PINI,"YES")
   field(SCAN,"Passive")
}

record(longout,"${DIG}NbrSegments")
{
   field(DESC,"nbrSegments")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} MNSGM")
   field(PINI,"YES")
   field(SCAN,"Passive")
}

record(longout,"${DIG}NbrBanks")
{
   field(DESC,"nbrBanks")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} MNBNK")
   field(PINI,"YES")
   field(SCAN,"Passive")
}

record(mbbo,"${DIG}Memflags")
{
   field(DESC,"memflags")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} MMMFL")
   field(PINI,"YES")
   field(SCAN,"Passive")
   field(ZRVL,"0")
   field(ZRST,"Default")
   field(ONVL,"1")
   field(ONST,"ForceInternal ")
}

record(mbbo,"${DIG}Mode")
{
   field(DESC,"mode")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} MMODE")
   field(PINI,"YES")
   field(SCAN,"Passive")
   field(ZRVL,"0")
   field(ZRST,"Normal_DAQ")
   field(ONVL,"1")
   field(ONST,"AC/SC")
   field(TWVL,"2")
   field(TWST,"Averaging")
   field(THVL,"3")
   field(THST,"Buffered_DAQ")
   field(FVVL,"5")
   field(FVST,"Peak_TDC")
   field(SXVL,"6")
   field(SXST,"FreqCounter")
   field(SVVL,"7")
   field(SVST,"SSR")
}

record(longout,"${DIG}Modifier")
{
   field(DESC,"modifier")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} MMDFR")
   field(PINI,"YES")
   field(SCAN,"Passive")
}

record(mbbo,"${DIG}ModeFlags")
{
   field(DESC,"modeFlags")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} MMDFL")
   field(PINI,"YES")
   field(SCAN,"Passive")
   field(ZRVL,"0")
   field(ZRST,"Normal")
   field(ONVL,"1")
   field(ONST,"StartOnTrig")
   field(TWVL,"2")
   field(TWST,"Sequence_Wrap")
}
