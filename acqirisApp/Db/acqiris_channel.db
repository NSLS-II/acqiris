## Yong Hu: simplify/reduce the original db by SLAC(Perazzo, Amedeo) to be dedicated for Acqiris digitizer
## functionality: for individual channel, configure input range, offset, triggering, coupling and bandwidth, \\
## \\get raw waveform data, process data by subArray record;
## PREFIX	- follows NSLS2 naming: [PSy[:PI]][-SSy[:SI]][-TSy[:TI]]{Dev[:DI]}[SgN[:SgI][-SgD]] 
#### Psy	-	Primary system
#### Ssy	-	Secondary system
#### Dev	-	Device name
## CHANNEL  -	#channel of the board(MODULE); "0" refers to the first channel  
## MODULE   -	#board / digitizer; "0" refers to the first digitizer found during initialization. \\
##              For Acqiris crate and Concurrent CPU, it's the top slot(#5) if there's one digitizer in slot 5 
## NELM     -	(max.) number of elements of waveform record 

record(ao,"${PREFIX}FullScale-SP")
{
   field(DESC,"Input Voltage Range")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} C${CHANNEL} CFLSC")
   field(PINI,"YES")
   field(SCAN,"Passive")
   field(DRVH,"5.0")
   field(DRVL,"-5.0")
   field(EGU,"V")
   field(PREC,"2")
   #seems 'VAL' doesn't work well here. use 'RVAL'
   info(autosaveFields_pass0, "RVAL")
}

record(ao,"${PREFIX}RangeOffset-SP")
{
   field(DESC,"Offset for Input Range")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} C${CHANNEL} COFFS")
   field(PINI,"YES")
   field(SCAN,"Passive")
   field(DRVH,"5.0")
   field(DRVL,"-5.0")
   field(EGU,"V")
   field(PREC,"2")
    #seems 'VAL' doesn't work well here. use 'RVAL'
    info(autosaveFields_pass0, "RVAL")
}

record(mbbo,"${PREFIX}Coupling-Sel")
{
   field(DESC,"Channel Coupling")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} C${CHANNEL} CCPLN")
   field(PINI,"YES")
   field(SCAN,"Passive")
   field(ZRVL,"0")
   field(ZRST,"Ground")
   field(ONVL,"1")
   field(ONST,"DC")
   field(TWVL,"2")
   field(TWST,"AC")
   field(THVL,"3")
   field(THST,"DC_50_Ohm")
   field(FRVL,"4")
   field(FRST,"AC_50_Ohm")
   info(autosaveFields_pass0, "RVAL")
}

record(mbbo,"${PREFIX}Bandwidth-Sel")
{
   field(DESC,"Bandwidth")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} C${CHANNEL} CBNDW")
   field(PINI,"YES")
   field(SCAN,"Passive")
   field(ZRVL,"0")
   field(ZRST,"No_Limit")
   field(ONVL,"1")
   field(ONST,"25Mhz")
   field(TWVL,"2")
   field(TWST,"700MHz")
   field(THVL,"3")
   field(THST,"200Mhz")
   field(FRVL,"4")
   field(FRST,"20Mhz")
   field(FVVL,"5")
   field(FVST,"35Mhz")
   info(autosaveFields_pass0, "RVAL")
}

#get voltage waveform data in acqiris_drv_wf.cpp; 
#doesn't subtract noise and no zeroing DC noise
#Sept.06, 2011: subtracting noise doesn't help
record(waveform,"${PREFIX}VoltData-Wf_")
{
   field(SCAN,"I/O Intr")
   field(DESC,"voltage waveform data")
   field(DTYP,"acqiris")
   field(NELM,"${NELM}")
   field(FTVL,"FLOAT")
   field(INP,"@M${MODULE} C${CHANNEL} WVOL")
   field(PREC,"4")
   field(EGU,"V")
   #save waveform data only if Nbrbunches >= 1
   #field(FLNK,"${PREFIX}VoltDataSaved-Wf_")
}

record(ao,"${PREFIX}PeakThreshold-SP")
{
   field(DESC,"Threshold for searching peak")
   field(DRVH,"5.0")
   field(DRVL,"-5.0")
   field(EGU,"V")
   field(PREC,"4")
   info(autosaveFields_pass0, "VAL")
}

#coefficient for calculation of absolute bunch charge of wall current monitor  
record(ao,"${PREFIX}CoefBunchQ-SP")
{
   field(DESC,"Coefficient")
   field(PINI,"YES")
   field(VAL, "1.0")
   field(PREC,"4")
   info(autosaveFields_pass0, "VAL")
}

record(longout,"${PREFIX}NbrSamplesForSum-SP")
{
   field(DESC,"NumberOfSamplesForIntegral")
   field(PINI,"YES")
   field(DRVH,"${NELM}")
   field(DRVL,"3")
   field(EGU,"Samples")
   info(autosaveFields_pass0, "VAL")
   field(FLNK,"${PREFIX}NbrSamplesForSum-Calc_")
 }

record(calc,"${PREFIX}NbrSamplesForSum-Calc_")
{
   field(DESC,"NumberShouldBeOdd")
   field(INPA,"${PREFIX}NbrSamplesForSum-SP")
   field(CALC,"(A%2 = 0) ? (A+1):A")
   info(autosaveFields_pass0, "VAL")
}

#Why need ZeroingOffset?
#there might be DC offset between the FCT and the digitizer even without real beam
#ZeroingOffset-SP == AveVolt-I
record(ao,"${PREFIX}ZeroingOffset-SP")
{
   field(DESC,"Offset for zeroing noise")
   field(PINI,"YES")
   field(SCAN,"Passive")
   field(DRVH,"5.0")
   field(DRVL,"-5.0")
   field(EGU,"V")
   field(PREC,"2")
   info(autosaveFields_pass0, "VAL")
}

#raw waveform data: 16-bit integer
record(waveform,"${PREFIX}RawData-Wf_")
{
   field(SCAN,"I/O Intr")
   field(DESC,"Raw waveform data")
   field(DTYP,"acqiris")
   field(NELM,"${NELM}")
   field(FTVL,"SHORT")
   field(INP,"@M${MODULE} C${CHANNEL} WRAW")
   field(PREC,"4")
   field(EGU,"Volts")
   field(FLNK,"${PREFIX}VoltWf-ASub_")
}

#see acqiris_asub_process.cpp: process the waveform record: voltage, max, min, ave, std, 
#number of bunches(peaks/pulse counts), filling pattern(pulse integral, normalization, etc.), individual bunch charge calibrated against ICT;
record(aSub,"${PREFIX}VoltWf-ASub_")
{
    field(DESC,"process raw waveform data")
    field (INAM,"acqirisAsubInit")
    field (SNAM,"acqirisAsubProcess")
    #get raw data (integer) from the waveform record above
    field (INPA, "${PREFIX}RawData-Wf_")
    field (FTA, "SHORT")
    field (NOA, "${NELM}")
    #get input range (Full scale)   
    field (INPB, "${PREFIX}FullScale-SP")
    field (FTB, "DOUBLE")
    field (NOB, "1")
    #get offset for input range   
    field (INPC, "${PREFIX}RangeOffset-SP")
    field (FTC, "DOUBLE")
    field (NOC, "1")
    #get peak threshold   
    field (INPD, "${PREFIX}PeakThreshold-SP")
    field (FTD, "DOUBLE")
    field (NOD, "1")
    #number of samples for integral value(individual bunch charge)   
    field (INPE, "${PREFIX}NbrSamplesForSum-Calc_")
    #${PREFIX}NbrSamplesForSum-calc_.VAL seems double, but it works here
    field (FTE, "LONG")
    field (NOE, "1")
    #coefficient for calculation of absolute bunch charge of wall current monitor  
    field (INPF, "${PREFIX}CoefBunchQ-SP")
    field (FTF, "DOUBLE")
    field (NOF, "1")
    #get offset for zeroing noise   
    field (INPG, "${PREFIX}ZeroingOffset-SP")
    field (FTG, "DOUBLE")
    field (NOG, "1")
    #voltage waveform data: should have the same data as ${PREFIX}VoltData-Wf_
    # if no subtracting background noise               
    field (OUTA, "${PREFIX}VoltData-Wf PP")
    field (FTVA, "DOUBLE")
    field (NOVA, "${NELM}")
    #max & min voltages               
    field (OUTB, "${PREFIX}MaxVolt-I PP")
    field (FTVB, "DOUBLE")
    field (NOVB, "1")
    field (OUTC, "${PREFIX}MinVolt-I PP")
    field (FTVC, "DOUBLE")
    field (NOVC, "1")
    #average value (Sum is not DC component), standard deviation/RMS noise
    field (OUTD, "${PREFIX}AveVolt-I PP")
    field (FTVD, "DOUBLE")
    field (NOVD, "1")
    field (OUTE, "${PREFIX}StdVolt-I PP")
    field (FTVE, "DOUBLE")
    field (NOVE, "1")
    #Number of bunches
    field (OUTF, "${PREFIX}NbrBunches-I PP")
    field (FTVF, "LONG")
    field (NOVF, "1")
    #normalized Filling pattern(max. 150 bunches for NSLS2): 0.85, 0.90, 1.00, ... 
    field (OUTG, "${PREFIX}FillPattern-Wf PP")
    field (FTVG, "DOUBLE")
    field (NOVG, "150")
    #Max. bunch-to-bunch charge variation < 20%
    field (OUTH, "${PREFIX}B2BMaxVar-I PP")
    field (FTVH, "DOUBLE")
    field (NOVH, "1")
    #individual bunch charge (Q) calibrated against nearby ICT
    field (OUTI, "${PREFIX}BunchQCalib-Wf PP")
    field (FTVI, "DOUBLE")
    field (NOVI, "150")
    #Which bunch has the highest/max. charge
    field (OUTJ, "${PREFIX}MaxQBunchNbr-I PP")
    field (FTVJ, "LONG")
    field (NOVJ, "1")
    #Which bunch has the lowest/min. charge
    field (OUTK, "${PREFIX}MinQBunchNbr-I PP")
    field (FTVK, "LONG")
    field (NOVK, "1")
    #integral value of individual bunch(max. 150 bunches for NSLS2) 
    ##calculate bunch charge by integrating samples: wall current monitor 
    field (OUTL, "${PREFIX}BunchQ-Wf PP")
    field (FTVL, "DOUBLE")
    field (NOVL, "150")
}

record(waveform,"${PREFIX}VoltData-Wf")
{
   field(SCAN,"Passive")
   field(DESC,"voltage waveform data by aSub")
   field(NELM,"${NELM}")
   field(FTVL,"DOUBLE")
   field(INP,"${PREFIX}VoltWf-ASub_.VALA")
   field(PREC,"4")
   field(EGU,"V")
}

record(ai,"${PREFIX}MaxVolt-I")
{
   field(DESC,"Max value")
   field(INP,"${PREFIX}VoltWf-ASub_.VALB")
   field(PREC,"4")
   field(EGU,"V")
}

record(ai,"${PREFIX}MinVolt-I")
{
   field(DESC,"Min value")
   field(INP,"${PREFIX}VoltWf-ASub_.VALC")
   field(PREC,"4")
   field(EGU,"V")
}

record(ai,"${PREFIX}AveVolt-I")
{
   field(DESC,"Averaged DC")
   field(INP,"${PREFIX}VoltWf-ASub_.VALD")
   field(PREC,"4")
   field(EGU,"Volts")
}

record(ai,"${PREFIX}StdVolt-I")
{
   field(DESC,"RMS noise")
   field(INP,"${PREFIX}VoltWf-ASub_.VALE")
   field(PREC,"4")
   field(EGU,"V")
}

record(longin,"${PREFIX}NbrBunches-I")
{
   field(DESC,"Number of bunches")
   field(INP,"${PREFIX}VoltWf-ASub_.VALF")
   field(EGU,"bunches")
   field(FLNK,"${PREFIX}SaveWf-Calc_")
}

#record(calcout, "${PREFIX}SaveWf-calcout_")
#{
	#field(DESC,"saveWaveformIfHaveBeam")
	#field(INPA,"${PREFIX}NbrBunch-I")
	#field(CALC,"(A>=1) ? 1:0")
	#field(OOPT,"When Non-zero")
	#field(DOPT,"Use CALC")
	#It seems OUT doesn't take PV, only take record?
	#filed(OUT,"${PREFIX}VoltWf-Saved_.PROC")
	#filed(OUT,"${PREFIX}VoltWf-Saved_.SDIS")
#}

record(calc, "${PREFIX}SaveWf-Calc_")
{
	field(DESC,"saveWaveformIfHaveBeam")
	field(INPA,"${PREFIX}NbrBunch-I")
	#disable scanning ${PREFIX}VoltWf-Saved_ if A<1(no beam)
	field(CALC,"(A>=1) ? 0:1")
	field(FLNK,"${PREFIX}VoltDataSaved-Wf_")
}

record(waveform,"${PREFIX}VoltDataSaved-Wf_")
{
   field(DESC,"saved waveform data")
   #DISV is 1 by default
   field(SDIS,"${PREFIX}SaveWf-Calc_")
   field(NELM,"${NELM}")
   field(FTVL,"FLOAT")
   field(INP,"${PREFIX}VoltData-Wf")
   field(PREC,"4")
   field(EGU,"V")
}

record(waveform,"${PREFIX}FillPattern-Wf")
{
   field(DESC,"normalized filling pattern")
   field(INP,"${PREFIX}VoltWf-ASub_.VALG")
   field(NELM,"150")
   field(FTVL,"DOUBLE")
   field(PREC,"4")
}

record(ai,"${PREFIX}B2BMaxVar-I")
{
   field(DESC,"bunch-to-bunch max. variation")
   field(INP,"${PREFIX}VoltWf-ASub_.VALH")
   field(PREC,"4")
}

#individual bunch charge (Q) calibrated against nearby ICT
record(waveform,"${PREFIX}BunchQCalib-Wf")
{
   field(DESC,"Calibrated bunch charge")
   field(INP,"${PREFIX}VoltWf-ASub_.VALI")
   field(NELM,"150")
   field(FTVL,"DOUBLE")
   field(PREC,"4")
   field(EGU,"nC")
}

record(longin,"${PREFIX}MaxQBunchNbr-I")
{
   field(DESC,"No# highest charge")
   field(INP,"${PREFIX}VoltWf-ASub_.VALJ")
}

record(longin,"${PREFIX}MinQBunchNbr-I")
{
   field(DESC,"No# lowest charge")
   field(INP,"${PREFIX}VoltWf-ASub_.VALK")
}

#calculate bunch charge by integrating samples: wall current monitor 
record(waveform,"${PREFIX}BunchQ-Wf")
{
   #field(DESC,"IntegralValueOfEachBunch")
   field(DESC,"ChargeOfEachBunch")
   field(INP,"${PREFIX}VoltWf-ASub_.VALL")
   field(NELM,"150")
   field(FTVL,"DOUBLE")
   field(PREC,"4")
   field(EGU,"nC")
}

record(subArray,"${PREFIX}Bunch1Q-SubAr")
{
   field(DESC,"ChargeOfTheFirstBunch-subArray")
   field(INP,"${PREFIX}BunchQ-Wf CPP")
   field(MALM,"150")
   field(INDX,"0")
   field(NELM,"1")
   field(FTVL,"DOUBLE")
   field(PREC,"4")
   field(EGU,"nC")
}

record(ai,"${PREFIX}Bunch1Q-I")
{
   field(DESC,"ChargeOfTheFirstBunch")
   field(INP,"${PREFIX}Bunch1Q-SubAr CPP")
   field(PREC,"4")
   field(EGU,"nC")
}

record(ai,"${PREFIX}TrigLevelRange")
{
   field(DESC,"TrigLevelRange")
   field(DTYP,"acqiris")
   field(INP,"@M${MODULE} C${CHANNEL} CTLRG")
   field(PINI,"YES")
   field(SCAN,"Passive")
}

record(mbbo,"${PREFIX}TrigCoupling-Sel")
{
   field(DESC,"Channel TrigCoupling")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} C${CHANNEL} CTRCP")
   field(PINI,"YES")
   field(SCAN,"Passive")
   field(ZRVL,"0")
   field(ZRST,"DC")
   field(ONVL,"1")
   field(ONST,"AC")
   field(TWVL,"2")
   field(TWST,"HF_Reject")
   field(THVL,"3")
   field(THST,"DC_50_Ohm")
   field(FRVL,"4")
   field(FRST,"AC_50_Ohm")
   info(autosaveFields_pass0, "RVAL")
}

record(mbbo,"${PREFIX}TrigSlope-Sel")
{
   field(DESC,"Channel TrigSlope")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} C${CHANNEL} CTRSL")
   field(PINI,"YES")
   field(SCAN,"Passive")
   field(ZRVL,"0")
   field(ZRST,"Positive")
   field(ONVL,"1")
   field(ONST,"Negative")
   field(TWVL,"2")
   field(TWST,"Out_of_Window")
   field(THVL,"3")
   field(THST,"Into_Window")
   field(FRVL,"4")
   field(FRST,"HF_Divide")
   field(FVVL,"5")
   field(FVST,"Spike_Stretcher")
   info(autosaveFields_pass0, "RVAL")
}

record(ao,"${PREFIX}TrigLevel1-SP")
{
   field(DESC,"Channel TrigLevel1")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} C${CHANNEL} CTRL1")
   field(PINI,"YES")
   field(SCAN,"Passive")
   field(DRVH,"50")
   field(DRVL,"0")
   field(EGU,"%")
   info(autosaveFields_pass0, "RVAL")
}

record(ao,"${PREFIX}TrigLevel2-SP")
{
   field(DESC,"Channel TrigLevel2 for Window TrigSlope")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} C${CHANNEL} CTRL2")
   field(PINI,"YES")
   field(SCAN,"Passive")
   field(DRVH,"50")
   field(DRVL,"0")
   field(EGU,"%")
   info(autosaveFields_pass0, "RVAL")
}

record(longin,"${PREFIX}OverloadStatus")
{
   field(DESC,"OverloadStatus")
   field(DTYP,"acqiris")
   field(INP,"@M${MODULE} C${CHANNEL} COVST")
   field(PINI,"YES")
   field(SCAN,"Passive")
}

record(longout,"${PREFIX}DitherRange")
{
   field(DESC,"DitherRange")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} C${CHANNEL} CDTRN")
   field(PINI,"YES")
   field(SCAN,"Passive")
}

record(longout,"${PREFIX}FixedSamples")
{
   field(DESC,"FixedSamples")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} C${CHANNEL} CFXSM")
   field(PINI,"YES")
   field(SCAN,"Passive")
}

record(mbbo,"${PREFIX}GateType")
{
   field(DESC,"GateType")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} C${CHANNEL} CGTTP")
   field(PINI,"YES")
   field(SCAN,"Passive")
   field(ONVL,"1")
   field(ONST,"User_Gates")
   field(TWVL,"2")
   field(TWST,"Threshold_Gates")
}

record(mbbo,"${PREFIX}HistoTDCEnable")
{
   field(DESC,"HistoTDCEnable")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} C${CHANNEL} CHTDE")
   field(PINI,"YES")
   field(SCAN,"Passive")
   field(ZRVL,"0")
   field(ZRST,"Disabled")
   field(ONVL,"1")
   field(ONST,"Enabled")
}

record(mbbo,"${PREFIX}InvertData")
{
   field(DESC,"InvertData")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} C${CHANNEL} CINDT")
   field(PINI,"YES")
   field(SCAN,"Passive")
   field(ZRVL,"0")
   field(ZRST,"No_Inversion")
   field(ONVL,"1")
   field(ONST,"Inversion")
}

record(longout,"${PREFIX}NbrMaxGates")
{
   field(DESC,"NbrMaxGates")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} C${CHANNEL} CNMXG")
   field(PINI,"YES")
   field(SCAN,"Passive")
}

record(longout,"${PREFIX}NbrSamples")
{
   field(DESC,"NbrSamples")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} C${CHANNEL} CNSML")
   field(PINI,"YES")
   field(SCAN,"Passive")
}

record(longout,"${PREFIX}NbrSegments")
{
   field(DESC,"NbrSegments")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} C${CHANNEL} CNSGM")
   field(PINI,"YES")
   field(SCAN,"Passive")
}

record(longout,"${PREFIX}NbrWaveforms")
{
   field(DESC,"NbrWaveforms")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} C${CHANNEL} CNWVF")
   field(PINI,"YES")
   field(SCAN,"Passive")
}

record(longout,"${PREFIX}NbrRoundRobins")
{
   field(DESC,"NbrRoundRobins")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} C${CHANNEL} CNRRB")
   field(PINI,"YES")
   field(SCAN,"Passive")
}

record(longout,"${PREFIX}NoiseBaseEnable")
{
   field(DESC,"NoiseBaseEnable")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} C${CHANNEL} CNBEN")
   field(PINI,"YES")
   field(SCAN,"Passive")
}

record(ao,"${PREFIX}NoiseBase")
{
   field(DESC,"NoiseBase")
   field(DTYP,"acqiris")
   field(OUT,"@M${MODULE} C${CHANNEL} CNSBS")
   field(PINI,"YES")
   field(SCAN,"Passive")
}


